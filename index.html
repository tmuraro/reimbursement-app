<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brachmann Reimbursement App</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://statics.teams.cdn.office.net/sdk/v1.11.0/js/MicrosoftTeams.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const ReimbursementApp = () => {
            const [currentUserEmail, setCurrentUserEmail] = useState('');
            const [userRole, setUserRole] = useState(null);
            const [users, setUsers] = useState(() => {
                const savedUsers = JSON.parse(localStorage.getItem('users')) || [];
                if (!savedUsers.find(u => u.email.toLowerCase() === "tmuraro@brachmannlogistics.com")) {
                    savedUsers.push({
                        email: "tmuraro@brachmannlogistics.com",
                        name: "Tacito Muraro",
                        role: "master",
                        superiorEmail: "",
                        kmRate: 0.50
                    });
                }
                return savedUsers;
            });
            const [requests, setRequests] = useState(JSON.parse(localStorage.getItem('requests')) || []);
            const [newUser, setNewUser] = useState({
                email: '',
                name: '',
                role: 'employee',
                superiorEmail: '',
                kmRate: 0.50
            });
            const [editingUser, setEditingUser] = useState(null);
            const [expenses, setExpenses] = useState([]);
            const [currentExpense, setCurrentExpense] = useState({
                type: 'kilometragem',
                quantity: 0,
                value: 0,
                description: '',
                file: null
            });
            const [notifications, setNotifications] = useState([]);
            const [isTeams, setIsTeams] = useState(false);

            // Função para inicializar o email do usuário
            useEffect(() => {
                const initializeUser = () => {
                    if (typeof microsoftTeams !== 'undefined') {
                        microsoftTeams.initialize(() => {
                            setIsTeams(true);
                            microsoftTeams.getContext((context) => {
                                const email = context.userPrincipalName ? context.userPrincipalName.toLowerCase() : "tmuraro@brachmannlogistics.com";
                                setCurrentUserEmail(email);
                            });
                        }, 5000);
                    } else {
                        setIsTeams(false);
                        setCurrentUserEmail("tmuraro@brachmannlogistics.com");
                    }
                };

                initializeUser();

                const timeout = setTimeout(() => {
                    if (!currentUserEmail) {
                        setIsTeams(false);
                        setCurrentUserEmail("tmuraro@brachmannlogistics.com");
                    }
                }, 5000);

                return () => clearTimeout(timeout);
            }, []);

            // Determina o papel do usuário com base no email
            useEffect(() => {
                if (currentUserEmail) {
                    const user = users.find(u => u.email.toLowerCase() === currentUserEmail);
                    if (user) {
                        setUserRole(user.role);
                    } else {
                        setUserRole(null);
                    }
                }
            }, [currentUserEmail, users]);

            // Salva usuários e solicitações no localStorage
            useEffect(() => {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('requests', JSON.stringify(requests));
            }, [users, requests]);

            // Calcula o valor da kilometragem com base no kmRate do usuário
            const calculateKilometragemValue = (quantity) => {
                const user = users.find(u => u.email === currentUserEmail);
                return user ? (user.kmRate * quantity) : 0;
            };

            // Função para obter o token de acesso do Microsoft Graph
            const getAccessToken = async () => {
                return new Promise((resolve, reject) => {
                    microsoftTeams.authentication.getAuthToken({
                        successCallback: (token) => resolve(token),
                        failureCallback: (error) => reject(error)
                    });
                });
            };

            // Função para enviar e-mail via Microsoft Graph
            const sendEmail = async (toEmail, subject, body, attachment = null) => {
                try {
                    const token = await getAccessToken();
                    const email = {
                        message: {
                            subject: subject,
                            body: {
                                contentType: "HTML",
                                content: body
                            },
                            toRecipients: [
                                {
                                    emailAddress: {
                                        address: toEmail
                                    }
                                }
                            ]
                        }
                    };

                    if (attachment) {
                        const reader = new FileReader();
                        reader.readAsDataURL(attachment);
                        reader.onloadend = async () => {
                            const base64Data = reader.result.split(',')[1];
                            email.message.attachments = [
                                {
                                    "@odata.type": "#microsoft.graph.fileAttachment",
                                    name: attachment.name,
                                    contentType: attachment.type,
                                    contentBytes: base64Data
                                }
                            ];

                            await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(email)
                            });
                        };
                    } else {
                        await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(email)
                        });
                    }

                    setNotifications([...notifications, `Email enviado para ${toEmail}: ${subject}`]);
                } catch (error) {
                    console.error('Erro ao enviar e-mail:', error);
                    setNotifications([...notifications, `Erro ao enviar e-mail para ${toEmail}: ${error.message}`]);
                }
            };

            // Adiciona uma despesa à lista de despesas do pedido
            const handleAddExpense = () => {
                const expense = {
                    type: currentExpense.type,
                    quantity: currentExpense.type === 'kilometragem' ? currentExpense.quantity : 0,
                    value: currentExpense.type === 'kilometragem' ? calculateKilometragemValue(currentExpense.quantity) : currentExpense.value,
                    description: currentExpense.description,
                    file: currentExpense.file ? URL.createObjectURL(currentExpense.file) : null,
                    fileRaw: currentExpense.file // Armazena o arquivo bruto para envio como anexo
                };
                setExpenses([...expenses, expense]);
                setCurrentExpense({ type: 'kilometragem', quantity: 0, value: 0, description: '', file: null });
            };

            // Manipula o envio do pedido de reembolso
            const handleSubmit = (e) => {
                e.preventDefault();
                if (expenses.length === 0) {
                    alert('Adicione pelo menos uma despesa ao pedido!');
                    return;
                }
                const user = users.find(u => u.email === currentUserEmail);
                const newRequest = {
                    id: Date.now(),
                    userEmail: currentUserEmail,
                    expenses: expenses,
                    totalValue: expenses.reduce((sum, exp) => sum + exp.value, 0),
                    status: 'pending',
                    comments: '',
                    createdAt: new Date().toISOString() // Adiciona a data de criação
